{"version":3,"file":"oauth2.base.esm.js","sources":["../../src/providers/oauth2.base.ts"],"sourcesContent":["import { Provider } from \"./base\";\r\nexport class OAuth2BaseProvider extends Provider {\r\n    async signin(event, auth) {\r\n        const { method } = event.request;\r\n        const { url } = event;\r\n        const state = [\r\n            `redirect=${url.searchParams.get(\"redirect\") ?? this.getUri(auth, \"/\", url.host)}`,\r\n        ].join(\",\");\r\n        const base64State = Buffer.from(state).toString(\"base64\");\r\n        const nonce = Math.round(Math.random() * 1000).toString();\r\n        const authUrl = await this.getAuthorizationUrl(event, auth, base64State, nonce);\r\n        if (method === \"POST\") {\r\n            return {\r\n                body: {\r\n                    redirect: authUrl,\r\n                },\r\n            };\r\n        }\r\n        return {\r\n            status: 302,\r\n            headers: {\r\n                Location: authUrl,\r\n            },\r\n        };\r\n    }\r\n    getStateValue(query, name) {\r\n        if (query.get(\"state\")) {\r\n            const state = Buffer.from(query.get(\"state\"), \"base64\").toString();\r\n            return state\r\n                .split(\",\")\r\n                .find((state) => state.startsWith(`${name}=`))\r\n                ?.replace(`${name}=`, \"\");\r\n        }\r\n    }\r\n    async callback(event, auth) {\r\n        const { request, url } = event;\r\n        const code = url.searchParams.get(\"code\");\r\n        const redirect = this.getStateValue(url.searchParams, \"redirect\");\r\n        const tokens = await this.getTokens(code, this.getCallbackUri(auth, url.host));\r\n        let user = await this.getUserProfile(tokens);\r\n        if (this.config.profile) {\r\n            user = await this.config.profile(user, tokens);\r\n        }\r\n        return [user, redirect ?? this.getUri(auth, \"/\", url.host)];\r\n    }\r\n}\r\n"],"names":[],"mappings":";;iCACwC,SAAS;AAAA,QACvC,OAAO,OAAO,MAAM;AACtB,UAAM,EAAE,WAAW,MAAM;AACzB,UAAM,EAAE,QAAQ;AAChB,UAAM,QAAQ;AAAA,MACV,YAAY,IAAI,aAAa,IAAI,eAAe,KAAK,OAAO,MAAM,KAAK,IAAI;AAAA,MAC7E,KAAK;AACP,UAAM,cAAc,OAAO,KAAK,OAAO,SAAS;AAChD,UAAM,QAAQ,KAAK,MAAM,KAAK,WAAW,KAAM;AAC/C,UAAM,UAAU,MAAM,KAAK,oBAAoB,OAAO,MAAM,aAAa;AACzE,QAAI,WAAW,QAAQ;AACnB,aAAO;AAAA,QACH,MAAM;AAAA,UACF,UAAU;AAAA;AAAA;AAAA;AAItB,WAAO;AAAA,MACH,QAAQ;AAAA,MACR,SAAS;AAAA,QACL,UAAU;AAAA;AAAA;AAAA;AAAA,EAItB,cAAc,OAAO,MAAM;AACvB,QAAI,MAAM,IAAI,UAAU;AACpB,YAAM,QAAQ,OAAO,KAAK,MAAM,IAAI,UAAU,UAAU;AACxD,aAAO,MACF,MAAM,KACN,KAAK,CAAC,WAAU,OAAM,WAAW,GAAG,WACnC,QAAQ,GAAG,SAAS;AAAA;AAAA;AAAA,QAG5B,SAAS,OAAO,MAAM;AACxB,UAAM,EAAE,SAAS,QAAQ;AACzB,UAAM,OAAO,IAAI,aAAa,IAAI;AAClC,UAAM,WAAW,KAAK,cAAc,IAAI,cAAc;AACtD,UAAM,SAAS,MAAM,KAAK,UAAU,MAAM,KAAK,eAAe,MAAM,IAAI;AACxE,QAAI,OAAO,MAAM,KAAK,eAAe;AACrC,QAAI,KAAK,OAAO,SAAS;AACrB,aAAO,MAAM,KAAK,OAAO,QAAQ,MAAM;AAAA;AAE3C,WAAO,CAAC,MAAM,YAAY,KAAK,OAAO,MAAM,KAAK,IAAI;AAAA;AAAA;;;;"}